{"version":3,"sources":["ControlManager.js"],"names":["app","require","ControlManager","BaseClass","extend","Init","JS_Name","cc","game","on","EVENT_HIDE","OnEventHide","bind","EVENT_SHOW","OnEventShow","ShareDefine","isAndroid","ComTool","IsAndroid","catchDataDict","Log","console","log","Client","CheckVpnUsed","IsOpenVpn","IsEnableCheckVpn","isOpenVpn","NativeManager","CallToNative","clientConfig","GetClientConfig","value","clickCb","NetManager","Disconnect","SetWaitForConfirm","ConfirmOK","msgID","type","msgArg","cbArg","content","ConfirmManager","SetWaitForConfirmForm","OnConFirm","ShowConfirm","clickType","backArgList","NetWork","ReConnect","CreateLoadPromise","resPath","resType","that","hasOwnProperty","loadData","bluebird","resolve","promisefunc","reject","loader","loadRes","error","ErrLog","stack","CreateLoadPromiseByUrl","load","CreateLoadDirPromise","loadResAll","loadDataList","ReleaseAllRes","key","indexOf","releaseRes","off","g_ControlManager","exports","GetModel"],"mappings":"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","file":"ControlManager.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\common","sourcesContent":["/*\n    控制器管理器\n*/\nvar app = require('app');\n\nvar ControlManager = app.BaseClass.extend({\n\n    Init: function () {\n        this.JS_Name = \"ControlManager\";\n\n        cc.game.on(cc.game.EVENT_HIDE, this.OnEventHide.bind(this));\n        cc.game.on(cc.game.EVENT_SHOW, this.OnEventShow.bind(this));\n        this.ShareDefine = app.ShareDefine();\n        this.isAndroid = app.ComTool().IsAndroid();\n        this.catchDataDict = {};\n\n        this.Log(\"Init\");\n    },\n\n    //--------------回掉函数---------------\n    //应用切入后台\n    OnEventHide: function () {\n        console.log(\"OnEventHide\");\n        console.log(\"WebSocket OnEventHide\");\n        app.Client.OnEventHide();\n    },\n\n    //应用显示\n    OnEventShow: function () {\n        console.log(\"OnEventShow\");\n        console.log(\"WebSocket OnEventShow\");\n\n        if (this.CheckVpnUsed()) {\n            return;\n        }\n\n        app.Client.OnEventShow();\n    },\n\n    IsOpenVpn: function () {\n        return false;\n        \n        if (!this.isAndroid) {\n            return false;\n        }\n\n        if (!this.IsEnableCheckVpn()) {\n            console.log(\"未启用VPN检测\");\n            return false;\n        }\n\n        let isOpenVpn = app.NativeManager().CallToNative(\"CheckVpnUsed\", [], \"Boolean\");\n        if (isOpenVpn) {\n            console.log(\"检测到VPN为开启状态\");\n        }\n        return isOpenVpn;\n    },\n\n    IsEnableCheckVpn: function () {\n        let clientConfig = app.Client.GetClientConfig();\n        if (!clientConfig) {\n            return false;\n        }\n\n        let value = clientConfig[\"isEnableCheckVpn\"];\n        if (\"false\" == value) return false;\n        if (\"true\" == value) return true;\n        \n        return false;\n    },\n\n    CheckVpnUsed: function (clickCb = null) {\n        if (this.IsOpenVpn()) {\n            app.NetManager().Disconnect();\n            this.SetWaitForConfirm('DNS中断', this.ShareDefine.ConfirmOK, [], [\"WEBSOCKET_DISCONNECT_VPN_CHECK\"], \"\", clickCb);\n            return true;\n        }\n        return false;\n    },\n\n    SetWaitForConfirm: function (msgID, type, msgArg = [], cbArg = [], content = \"\", clickCb) {\n        let ConfirmManager = app.ConfirmManager();\n        if (!!clickCb) {\n            console.log(\"clickCb\", clickCb)\n            ConfirmManager.SetWaitForConfirmForm(() => {\n                console.log(\"VPN 断连后，需要重新建立连接 clickCb\");\n                this.CheckVpnUsed();\n                clickCb();\n            }, msgID, cbArg);\n        } else {\n            ConfirmManager.SetWaitForConfirmForm(this.OnConFirm.bind(this), msgID, cbArg);\n        }\n        ConfirmManager.ShowConfirm(type, msgID, msgArg, content);\n    },\n\n    OnConFirm: function (clickType, msgID, backArgList) {\n        if (clickType != \"WEBSOCKET_DISCONNECT_VPN_CHECK\") {\n            console.log(\"VPN 断连后，需要重新建立连接 OnConFirm\");\n            app.NetWork().ReConnect();\n            this.CheckVpnUsed();\n        }\n    },\n\n    //---------------加载资源-----------------\n\n    //创建异步下载资源对象\n    CreateLoadPromise: function (resPath, resType = \"\") {\n        this.Log(\"CreateLoadPromise failed resPath(%s) resType(%s)\", resPath, resType);\n\n        let that = this;\n        //如果已经加载\n        if (this.catchDataDict.hasOwnProperty(resPath)) {\n            let loadData = this.catchDataDict[resPath];\n            return app.bluebird.resolve(loadData)\n        }\n        //创建异步函数\n        let promisefunc = function (resolve, reject) {\n            //加载资源\n\n            cc.loader.loadRes(resPath, resType, function (error, loadData) {\n                if (error) {\n                    reject(error);\n                    that.ErrLog(\"CreateLoadPromise failed resPath(%s) resType(%s), error:%s\", resPath, resType, error.stack);\n                    that.ErrLog(\"CreateLoadPromise loadData(%s)\", loadData);\n\n                    return\n                }\n                that.catchDataDict[resPath] = loadData;\n\n                resolve(loadData);\n            })\n        };\n        //返回异步对象\n        return new app.bluebird(promisefunc);\n    },\n\n    //加载JSON文件 cc.url.raw('resources/json/' + jsonFileName + \".json\");\n    CreateLoadPromiseByUrl: function (resPath) {\n        let that = this;\n\n        //创建异步函数\n        let promisefunc = function (resolve, reject) {\n            //加载资源\n            cc.loader.load(resPath, function (error, loadData) {\n\n                if (error) {\n                    reject(error);\n                    return\n                }\n\n                resolve(loadData);\n            })\n        };\n        //返回异步对象\n        return new app.bluebird(promisefunc);\n    },\n\n    //创建异步下载文件夹所有文件对象\n    CreateLoadDirPromise: function (resPath, resType = \"\") {\n        //创建异步函数\n        let promisefunc = function (resolve, reject) {\n            //加载资源\n            cc.loader.loadResAll(resPath, resType, function (error, loadDataList) {\n\n                if (error) {\n                    reject(error);\n                    return\n                }\n\n                resolve(loadDataList);\n            })\n        };\n        //返回异步对象\n        return new app.bluebird(promisefunc);\n    },\n\n    //---------------释放资源-----------------\n    ReleaseAllRes: function () {\n        for (var key in this.catchDataDict) {\n            console.log(\"ReleaseAllRes key:\" + key);\n            if (key.indexOf(\"jsonData\") > -1) {\n                //只释放配表资源\n                cc.loader.releaseRes(key);\n            }\n        }\n        this.catchDataDict = {};\n        cc.game.off(cc.game.EVENT_HIDE);\n        cc.game.off(cc.game.EVENT_SHOW);\n    },\n});\n\n\nvar g_ControlManager = null;\n\n/**\n * 绑定模块外部方法\n */\nexports.GetModel = function () {\n    if (!g_ControlManager) {\n        g_ControlManager = new ControlManager();\n    }\n    return g_ControlManager;\n}"]}