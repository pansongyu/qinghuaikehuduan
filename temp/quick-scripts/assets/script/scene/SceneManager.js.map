{"version":3,"sources":["SceneManager.js"],"names":["app","require","SceneManager","BaseClass","extend","Init","JS_Name","SceneInfo","SysDataManager","GetTableDict","backMusicSoundID","beforeBackMusicSoundName","mapID","sceneName","sceneComponent","loadingNode","isLoading","isFirstEnterMainScene","Client","RegEvent","OnEvent_ModalLayer","OnEvent_OnShakeScene","Log","event","WarnLog","OnTopEvent","OnEventHide","OnEventShow","bReConnect","OnShakeScene","LoadScene","hasOwnProperty","ErrLog","ReadyLoadScene","lastSceneName","lastSceneScriptName","lastSceneScript","that","cc","find","getComponent","bluebirdObj","FormManager","LoadSceneDefaultForm","then","StartLoadScene","catch","error","stack","formPath2RealPath","formPath","indexOf","RealGamePrefab","GamePrefab","is3DShow","LocalDataManager","GetConfigProperty","gamePrefab","OnBeforeExitScene","director","loadScene","OnLoadSceneEnd","bind","ControlManager","CreateLoadPromise","prefab","preloadScene","ShowHelp","eventID","eventNode","PlayMusic","backGroundSound","backVolume","StopSceneMusic","SoundManager","PlayBackMusic","soundID","PauseSceneMusic","PauseSound","RecoverySceneMusic","ResumeSound","StopSoundByAudioID","UpdateSceneMusic","volume","audioEngine","setVolume","console","log","game","removePersistRootNode","removeFromParent","sceneScriptName","node","c","Canvas","heightWidth","winSize","height","width","ComTool","IsIpad","fitWidth","OnSwithSceneEnd","OnFirstEnterMainScene","PlayerHelpManager","OnShowDefaultForm","OnTimer","passSecond","OnBaseTimer","OnReload","GetSceneType","GetSceneComponent","GetMapID","g_SceneManager","exports","GetModel"],"mappings":"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","file":"SceneManager.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\scene","sourcesContent":["/*\n\t场景管理器\n*/\n\nvar app = require('app');\n\nvar SceneManager = app.BaseClass.extend({\n\n    Init:function(){\n    \tthis.JS_Name = \"SceneManager\";\n\n        this.SceneInfo = app.SysDataManager().GetTableDict(\"SceneInfo\");\n\n        this.backMusicSoundID = -1;\n        this.beforeBackMusicSoundName = \"\";\n\n        this.mapID = 0;\n        this.sceneName = \"\";\n        //当前场景的组件对象\n        this.sceneComponent = null;\n\n        this.loadingNode = null;\n\n        this.isLoading = false;\n\n        this.isFirstEnterMainScene = true;\n\n        app.Client.RegEvent(\"ModalLayer\", this.OnEvent_ModalLayer, this);\n\t    app.Client.RegEvent(\"ShakeScene\",this.OnEvent_OnShakeScene, this);\n\n    \tthis.Log(\"Init\");\n    },\n\n    //---------------回掉事件---------------\n    //显示最顶层layer\n    OnEvent_ModalLayer:function(event){\n        if(!this.sceneComponent){\n            this.WarnLog(\"OnEvent_ModalLayer not sceneName\");\n            return\n        }\n        this.sceneComponent.OnTopEvent(event);\n    },\n\n    //应用切入后台\n    OnEventHide:function(){\n        if(!this.sceneComponent){\n            this.WarnLog(\"OnEventHide not sceneName\");\n            return\n        }\n        this.sceneComponent.OnEventHide();\n    },\n\n    //应用显示\n    OnEventShow:function(bReConnect){\n        if(!this.sceneComponent){\n            this.WarnLog(\"OnEventShow not sceneName\");\n            return\n        }\n        this.sceneComponent.OnEventShow(bReConnect);\n    },\n\n\tOnEvent_OnShakeScene:function(){\n\t\tif(!this.sceneComponent){\n\t\t\tthis.WarnLog(\"OnEvent_ModalLayer not sceneName\");\n\t\t\treturn\n\t\t}\n\t\tthis.sceneComponent.OnShakeScene();\n\t},\n    //---------------外部操作接口----------------\n\n    //切换场景\n    LoadScene:function(sceneName, mapID=0){\n        if(!this.SceneInfo.hasOwnProperty(sceneName)){\n            this.ErrLog(\"LoadScene(%s) SceneInfo.txt not find\", sceneName);\n            return;\n        }\n\n        if(this.isLoading){\n            this.ErrLog(\"LoadScene(%s) fail doing (%s) loading now\", sceneName, this.sceneName);\n            return;\n        }\n\n        this.isLoading = true;\n        this.ReadyLoadScene(sceneName,mapID);\n    },\n    ReadyLoadScene:function(sceneName,mapID){\n        let lastSceneName = this.sceneName;\n        this.Log(\"LoadScene((%s,%s) -> (%s,%s))\", lastSceneName, this.mapID, sceneName, mapID);\n        this.mapID = mapID;\n        this.sceneName = sceneName;\n        let lastSceneScriptName = \"\";\n        let lastSceneScript = null;\n        let that = this;\n        //如果前一个场景不是启动场景\n        if(this.SceneInfo.hasOwnProperty(lastSceneName)){\n            lastSceneScriptName = this.SceneInfo[lastSceneName][\"ComponentName\"];\n            //找到场景对应的脚本组件\n            \n            lastSceneScript = cc.find('Canvas').getComponent(lastSceneScriptName);\n        }\n\n        let bluebirdObj = app.FormManager().LoadSceneDefaultForm(sceneName);\n\n        //如果返回异步对象,需要登录异步执行完成,在进入切换场景\n        if(bluebirdObj){\n            bluebirdObj.then(function(){\n                    that.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\n                })\n                .catch(function(error){\n                    that.ErrLog(\"LoadSceneDefaultForm(%s) error:%s\", sceneName, error.stack);\n\n                    that.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\n                })\n        }\n        else{\n            this.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\n        }\n    },\n    formPath2RealPath:function(formPath){\n        if(formPath.indexOf('/')<1){\n            return 'ui/'+formPath;\n        }\n        return formPath;\n    },\n    RealGamePrefab:function(GamePrefab){\n            let is3DShow=app.LocalDataManager().GetConfigProperty(\"SysSetting\", \"is3DShow\");\n            if(is3DShow==0 && GamePrefab=='game/ZJMJ/ui/UIZJMJPlay'){\n                 //2D场景需要切换\n                 GamePrefab='game/ZJMJ/ui/UIZJMJ2DPlay';\n            }\n            if(is3DShow==2 && GamePrefab=='game/ZJMJ/ui/UIZJMJPlay'){\n                 //2D场景需要切换\n                 GamePrefab='game/ZJMJ/ui/UIZJMJKXPlay';\n            }\n            if(is3DShow==3 && GamePrefab=='game/ZJMJ/ui/UIZJMJPlay'){\n                 //2D场景需要切换\n                 GamePrefab='game/ZJMJ/ui/UIZJMJ17Play';\n            }\n            return this.formPath2RealPath(GamePrefab);\n    },\n\tStartLoadScene:function(lastSceneScript, lastSceneScriptName, sceneName){\n        //预加载有戏场景开始\n        // console.log(\"StartLoadScene sceneName == \" + sceneName);\n        // console.log(\"StartLoadScene SceneInfo == \" + JSON.stringify(this.SceneInfo));\n        let GamePrefab=this.SceneInfo[sceneName].gamePrefab;\n        let that = this;\n        if(GamePrefab==0){\n            //退出当前场景\n            if(lastSceneScript){\n                lastSceneScript.OnBeforeExitScene();\n            }\n            //关闭场景界面和模型\n            app.FormManager().OnBeforeExitScene(lastSceneScriptName);\n            //加载失败,也要切换进场景\n            this.sceneComponent = null;\n            cc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\n            \n        }else{\n            app.ControlManager().CreateLoadPromise(this.RealGamePrefab(GamePrefab))\n            .then(function(prefab){\n                //退出当前场景\n                //加载失败,也要切换进场景\n                that.sceneComponent = null;\n                cc.director.preloadScene(sceneName, function () {\n                    \n                    if(lastSceneScript){\n                        lastSceneScript.OnBeforeExitScene();\n                    }\n                    //关闭场景界面和模型\n                    app.FormManager().OnBeforeExitScene(lastSceneScriptName);\n\n                    cc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\n                });\n                return;\n            })\n            .catch(function(error){\n                //\n            })\n        }\n        //预加载有戏场景\n\t\t\n\t},\n\n    ShowHelp:function(eventID, eventNode){\n        if(this.sceneComponent){\n            this.sceneComponent.ShowHelp(eventID, eventNode);\n        }\n    },\n\n    //播放背景音乐\n    PlayMusic:function(backGroundSound){\n        let backVolume = app.LocalDataManager().GetConfigProperty(\"SysSetting\", \"BackVolume\");\n        //如果关闭音效\n        if(!backVolume){\n            return;\n        }\n        if(!this.SceneInfo.hasOwnProperty(this.sceneName)){\n            this.ErrLog(\"PlayMusic failed, SceneInfo.txt not find:%s\", this.sceneName);\n            return\n        }\n\n        if(!backGroundSound){\n            backGroundSound = this.SceneInfo[this.sceneName][\"BackGroundSound\"];\n            //读取缓存的背景音乐\n            if(backGroundSound != \"\" && backGroundSound != \"0\"){\n                backGroundSound=app.LocalDataManager().GetConfigProperty(\"SysSetting\",\"MainBackMusic\");\n            }\n            //读取缓存的背景音乐\n        }\n\n        if(!backGroundSound){\n            return\n        }\n\n        //如果切换场景时，两个场景播放的背景音乐相同则不需要再次播放\n        // if(this.beforeBackMusicSoundName == backGroundSound){\n        //     return;\n        // }\n        //如果背景音乐不同，则先停止上一个场景残留的背景音乐，重新播放新的背景音乐\n        this.StopSceneMusic();\n        this.beforeBackMusicSoundName = backGroundSound;\n\n        let that = this;\n        app.SoundManager().PlayBackMusic(backGroundSound)\n            .then(function(soundID){\n                that.backMusicSoundID = soundID;\n            })\n    },\n\n    PauseSceneMusic:function () {\n        if(this.backMusicSoundID != -1){\n            app.SoundManager().PauseSound(this.backMusicSoundID);\n        }\n    },\n    RecoverySceneMusic:function () {\n        if(this.backMusicSoundID != -1){\n            app.SoundManager().ResumeSound(this.backMusicSoundID);\n        }\n    },\n\tStopSceneMusic:function(){\n\t\tif(this.backMusicSoundID != -1){\n            app.SoundManager().StopSoundByAudioID(this.backMusicSoundID);\n\t\t}\n\t},\n    UpdateSceneMusic:function () {\n        if(this.backMusicSoundID != -1){\n            let volume = app.LocalDataManager().GetConfigProperty(\"SysSetting\",\"BackVolume\");\n            cc.audioEngine.setVolume(this.backMusicSoundID, volume);\n        }\n    },\n    //------------回掉函数-------------------\n\n    //场景加载完成回掉\n    OnLoadSceneEnd:function(){\n        this.Log(\"OnLoadSceneEnd sceneName:%s\", this.sceneName);\n\n        this.isLoading = false;\n        console.log(\"unload uiwaitform  begein\");\n        if (this.loadingNode) {\n            cc.game.removePersistRootNode(this.loadingNode);\n            this.loadingNode.removeFromParent();\n            console.log(\"unload uiwaitform success\");\n        }\n\t\t\n\t\tif(!this.SceneInfo.hasOwnProperty(this.sceneName)){\n\t\t\tthis.ErrLog(\"OnLoadSceneEnd SceneInfo.txt not find:(%s)\", this.sceneName);\n\t\t\treturn \n        }\n\t    let sceneScriptName = this.SceneInfo[this.sceneName][\"ComponentName\"];\n\t    //找到场景对应的脚本组件\n\n\t    this.sceneComponent = cc.find('Canvas').getComponent(sceneScriptName);\n\n        let node=cc.find('Canvas');\n        let c=node.getComponent(cc.Canvas);\n        let heightWidth = cc.winSize.height/cc.winSize.width;\n        if(app.ComTool().IsIpad() || heightWidth > 0.6){\n            c.fitWidth=true;\n        }else{\n            c.fitWidth=false;\n        }\n        \n        /*if(cc.winSize.width/cc.winSize.height>2){\n            //宽屏手机，两边各留100像素\n            let d=node.getComponent(cc.Widget);\n            d.left=100;\n            d.right=100;\n        }*/\n\n\n        let FormManager = app.FormManager();\n\n        FormManager.OnSwithSceneEnd(this.sceneName);\n\n        if(this.isFirstEnterMainScene){\n            if(this.sceneName == \"mainScene\"){\n                app.Client.OnFirstEnterMainScene();\n                this.isFirstEnterMainScene = false;\n            }\n        }\n        else{\n            app.PlayerHelpManager().OnSwithSceneEnd(this.sceneName);\n        }\n\n\t    this.sceneComponent.OnShowDefaultForm();\n\t    this.sceneComponent.OnSwithSceneEnd();\n\n\t    this.PlayMusic();\n    },\n\n    //定时回掉\n    OnTimer:function(passSecond){\n        if(this.sceneComponent){\n            this.sceneComponent.OnBaseTimer(passSecond);\n        }\n    },\n\n    //切换账号\n    OnReload:function(){\n        this.isFirstEnterMainScene = true;\n    },\n    //-----------------获取接口---------------------------\n\n    //获取当前加载的场景名\n    GetSceneType:function(){\n    \treturn this.sceneName;\n    },\n\n    //获取当前场景的组件对象\n    GetSceneComponent:function(){\n        return this.sceneComponent\n    },\n\n    //获取当前场景的地图ID\n    GetMapID:function(){\n        return this.mapID\n    },\n});\n\n\n\nvar g_SceneManager = null;\n\n/**\n * 绑定模块外部方法\n */\nexports.GetModel = function(){\n    if(!g_SceneManager){\n        g_SceneManager = new SceneManager();\n    }\n    return g_SceneManager;\n}\n\n"]}